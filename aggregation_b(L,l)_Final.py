# -*- coding: utf-8 -*-
"""
Created on Fri Mar 26 20:49:21 2021

@author: Manos
"""
import numpy as np
import scipy.integrate as integrate
from numpy import sqrt, sin, cos, pi
import math 
import pylab as pp
from pymaxent import moments_c,maxent_reconstruct_c0_1,maxent_reconstruct_c1_1,temp1
import time 
import matplotlib.pyplot as plt


start = time.time()

'''Αρχικοποίση των μεταβλητών'''

tspan=(0, 100)
resolution = 50
teval = np.linspace(tspan[0],tspan[1],resolution+1)

initial_m=[]
for i in range(4):
    def distr(L,i=i):
        return (L**i)*3*L**2*np.exp(-L**3)
   
    m, err=integrate.quad(distr, 0, np.inf)
    print('m(',i,')=',m)
    initial_m.append(m)



''' Επίλυση του συστήματος διαφορικών εξισώσεων με την Maximum Entropy'''
mu=[initial_m[0],initial_m[1],initial_m[2],initial_m[3]]
sol0,lambdas=maxent_reconstruct_c0_1(mu=mu,bnds=[0,2])
temp1 = lambdas


def moments(t,y):
    m0 = y[0]
    m1 = y[1]
    m2 = y[2]
    m3 = y[3]
    Lmean=m1/m0
    σ=np.abs(m2-Lmean**2)**(1/2)
    Lmin=max(0,Lmean-2.4*σ)
    Lmax=Lmean+3*σ
    bnds=[Lmin,Lmax]
    print(bnds)
    
    def b(L,λ):
        b0=1
        b=(L+λ)**2/(λ*L)
        return(b0*b)
    
    sol, lambdas= maxent_reconstruct_c1_1(mu=y ,bnds=bnds)

    print('time is', t, 's')
    
    def moment0(L,λ):
        if L<= 10**(-3) or λ<= 10**(-3):
            return(0)
        else: 
            return(-1/2*b(L,λ)*sol(L)*sol(λ))
    dm0dt, err0 = integrate.dblquad(moment0, bnds[0], bnds[1], bnds[0], bnds[1],epsabs=1e-3,epsrel=1e-3)
    
    def moment1(L,λ):
        if L<= 10**(-3) or λ<= 10**(-3):
            return(0)
        else: 
            return(((L**3+λ**3)**(1/3)/2-L)*b(L,λ)*sol(L)*sol(λ))
    dm1dt, err1=integrate.dblquad(moment1, bnds[0], bnds[1], bnds[0], bnds[1],epsabs=1e-3,epsrel=1e-3) 
    
    def moment2(L,λ):
        if L<= 10**(-3) or λ<= 10**(-3):
            return(0)
        else: 
            return(((L**3+λ**3)**(2/3)/2-L**2)*b(L,λ)*sol(L)*sol(λ))
    dm2dt, err2=integrate.dblquad(moment2, bnds[0], bnds[1], bnds[0], bnds[1],epsabs=1e-3,epsrel=1e-3) 
    
    dm3dt=0
    
    return(dm0dt,dm1dt,dm2dt,dm3dt)


'''Χρήση της BDF, step by step'''


r=integrate.solve_ivp(moments ,tspan, initial_m, method='BDF',t_eval=teval, jac=None, rtol=10**(-3))

end = time.time()
print('Total time =',(end-start)/60,'min')



'''Κατασκευή γραφημάτων της κατανομής για συγκεκριμένες χρονικές στιγμές'''

'''t=0'''

L=np.linspace(0, 2,51)

pp.figure(1)

mu0=[initial_m[0],initial_m[1],initial_m[2],initial_m[3]]
sol0, lambdas0=maxent_reconstruct_c0_1(mu=mu0,bnds=[0,5*L[50]/2])
pp.plot(L,sol0(L))
pp.title('t = 0')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n #/mLμL',{"fontsize":16})



'''t=20'''

L=np.linspace(0,6,51)

pp.figure(2)

mu20=[r.y[0,10],r.y[1,10],r.y[2,10],r.y[3,10]]
sol20, lambdas20=maxent_reconstruct_c0_1(mu=mu20,bnds=[0,5*L[50]/2])
pp.plot(L,sol20(L))
pp.title('t = 20')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n #/mLμL',{"fontsize":16})



'''t=40'''

L=np.linspace(0,8,51)
pp.figure(3)

mu40=[r.y[0,20],r.y[1,20],r.y[2,20],r.y[3,20]]
sol40, lambdas40=maxent_reconstruct_c0_1(mu=mu40,bnds=[0,5*L[50]/2])
pp.plot(L,sol40(L))
pp.title('t = 40')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n #/mLμL',{"fontsize":16})



'''t=60'''

L=np.linspace(0,10,51)
pp.figure(4)

mu60=[r.y[0,30],r.y[1,30],r.y[2,30],r.y[3,30]]
sol60, lambdas60=maxent_reconstruct_c0_1(mu=mu60,bnds=[0,5*L[50]/2])
pp.plot(L,sol60(L))
pp.title('t = 60')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n #/mLμL',{"fontsize":16})


'''t=80'''

L=np.linspace(0,10,51)
pp.figure(5)

mu80=[r.y[0,40],r.y[1,40],r.y[2,40],r.y[3,40]]
sol80, lambdas80=maxent_reconstruct_c0_1(mu=mu80,bnds=[0,5*L[50]/2])
pp.plot(L,sol80(L))
pp.title('t = 80')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n #/mLμL',{"fontsize":16})



'''t=100'''


L=np.linspace(0,12,51)
pp.figure(6)

mu100=[r.y[0,50],r.y[1,50],r.y[2,50],r.y[3,50]]
sol100, lambdas100=maxent_reconstruct_c0_1(mu=mu100,bnds=[0,5*L[50]/2])
pp.plot(L,sol100(L))
pp.title('t = 100')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n #/mLμL',{"fontsize":16})


'''Ολικό γράφημα του travelling wave '''

pp.figure(7)
pp.plot(L,sol20(L),L,sol40(L),L,sol60(L),L,sol80(L),L,sol100(L))
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n(#/μm.mL)',{"fontsize":16})
pp.legend(('20 min','40 min','60 min','80 min','100 min'),loc=0)
pp.show 




'''Συγκριση με δεδομενα απο comsol'''

μ0=np.zeros(51)
μ1=np.zeros(51)
μ2=np.zeros(51)
μ3=np.zeros(51)


x0=[0.9995580871743954,
 0.3136086817046955,
 0.18625185115725465,
 0.1326503092611443,
 0.10311240988137539,
 0.08431884798529625,
 0.07132153175613319,
 0.06182703823975088,
 0.05454401081282154,
 0.04880091386155766,
 0.04415782918040211,
 0.040325192177295396,
 0.0370833177573471,
 0.034320271889961174,
 0.03194199309687108,
 0.029874544034998694,
 0.02806079943795995,
 0.026456537019251117,
 0.025027224478452462,
 0.023745499538550954,
 0.022589459556773255,
 0.021541360934099897,
 0.02058667166259583,
 0.019713371929683407,
 0.018911430588671094,
 0.01817240796421369,
 0.017489150691324333,
 0.016855554527671963,
 0.01626663089937109,
 0.015717417741221748,
 0.015204298181656343,
 0.014723555473928599,
 0.014272442237159408,
 0.013848088996546912,
 0.013448364346475493,
 0.013071138677846207,
 0.012714531457573688,
 0.012376884310409394,
 0.012056719695718145,
 0.011752712064898453,
 0.011463667224764653,
 0.01118850605234374,
 0.010926250871595404,
 0.010676013784986367,
 0.010436986589699184,
 0.0102084320243597,
 0.009989676145242373,
 0.00978010166568733,
 0.009579142119722106,
 0.009386276733242403,
 0.009201025904573862,
 0.0090229472115055,
 0.00885163187454349,
 0.008686701616655579,
 0.008527805868559564,
 0.008374619275959299,
 0.008226839471315207,
 0.008084185077943385,
 0.007946393918646872,
 0.0078132214048209,
 0.0076844390851582385,
 0.007559833335794922,
 0.007439204176063583,
 0.007322364196015442,
 0.007209137583588159,
 0.007099359240778645,
 0.006992873979458202,
 0.006889535788577834,
 0.006789207165474746,
 0.006691758504829186,
 0.006597067539553515,
 0.0065050188285337585,
 0.0064155032867047185,
 0.006328417753431353,
 0.006243664595600677,
 0.006161151342209916,
 0.006080790347572111,
 0.006002498480557087,
 0.005926196837549399,
 0.005851810477037014,
 0.005779268173952463,
 0.005708502192071623,
 0.005639448072940307,
 0.005572044439944686,
 0.005506232816272143,
 0.005441957455627895,
 0.005379165184675303,
 0.005317805256263774,
 0.005257829212592212,
 0.00519919075753159,
 0.005141845637399377,
 0.005085751529540035,
 0.0050308679381217735,
 0.004977156096609532,
 0.004924578876421108,
 0.004873100701313116,
 0.004822687467082115,
 0.004773306466199506,
 0.004724926317030433,
 0.004677516897314207,
 0.004631049281610214]

x1=[0.8927250397229604,
 0.41740413999957177,
 0.29545217039007593,
 0.23573254267124416,
 0.19929823193598015,
 0.17428316463943505,
 0.15588005275880745,
 0.1417055702894194,
 0.13034439275238272,
 0.12102227963568221,
 0.11321268100828893,
 0.10655639130966342,
 0.10077081318176996,
 0.09570705284316891,
 0.09123739275694129,
 0.08725923277844884,
 0.08369152705274294,
 0.08047015011264198,
 0.07754397202292576,
 0.07487164103461384,
 0.07241942660485418,
 0.07015951016126053,
 0.06806871899606272,
 0.06612757590826486,
 0.06431957609387984,
 0.06263062982949866,
 0.06104862779784314,
 0.05956309834693127,
 0.05816538122544644,
 0.05684674720294508,
 0.05560075983704249,
 0.054420727897864285,
 0.05330164913295651,
 0.05223824615700783,
 0.05122655495215556,
 0.050262579666749053,
 0.04934275760450123,
 0.048463916232623215,
 0.047623202396525344,
 0.046818033429354144,
 0.04604606241369757,
 0.04530515071200275,
 0.04459334483588063,
 0.043908856480023115,
 0.04325004513072539,
 0.04261540285105959,
 0.04200354092777644,
 0.041413178117892496,
 0.04084313027427432,
 0.04029230116365862,
 0.0397596743189469,
 0.0392443057912684,
 0.038745317687049856,
 0.03826189239186226,
 0.03779326739670477,
 0.03733873065408583,
 0.036897616401169085,
 0.036469301395645075,
 0.0360532015171453,
 0.035648768693112086,
 0.03525548811327153,
 0.03487287570133248,
 0.0345004758164043,
 0.034137859159951336,
 0.03378462086699087,
 0.033440378762735985,
 0.03310477176806102,
 0.032777458439058736,
 0.032458115627613617,
 0.03214643725135743,
 0.03184213316264564,
 0.0315449281073046,
 0.03125456076487965,
 0.030970782862979346,
 0.030693358359074396,
 0.03042206268378561,
 0.030156682040294182,
 0.02989701275503908,
 0.02964286067534024,
 0.02939404061000565,
 0.029150375809360453,
 0.02891169748146596,
 0.02867784434160296,
 0.02844866219235824,
 0.028224003531899345,
 0.02800372718823429,
 0.027787697977453434,
 0.027575786384123353,
 0.027367868262162694,
 0.027163824554671555,
 0.02696354103131846,
 0.026766908042003604,
 0.026573820285623016,
 0.026384176592858483,
 0.026197879721999762,
 0.026014836166891656,
 0.025834955976164153,
 0.02565815258297681,
 0.025484342644562338,
 0.025313445890914145,
 0.025145384982009817]

x2=[0.9026182360243306  ,
0.6189997582951756  ,
0.5210159929636327  ,
0.4654259939289009  ,
0.4279333380581812  ,
0.400170271639641   ,
0.37844858407960685 ,
0.36081417043011077 ,
0.3460439497379831  ,
0.33343438791485214 ,
0.3224888516044018  ,
0.31285630300030454 ,
0.3042504594094776  ,
0.2965153351846871  ,
0.2895143208303454  ,
0.2831352421323383  ,
0.27728750559288956 ,
0.27189785476893835 ,
0.2669066641612473  ,
0.2622647069356728  ,
0.2579310747222623  ,
0.2538714260564818  ,
0.2500566690871532  ,
0.2464619572625881  ,
0.24306591301659208 ,
0.23985002014314022 ,
0.23679814278691044 ,
0.2338961407270941  ,
0.23113216527460817 ,
0.22849415259253963 ,
0.22597306695471314 ,
0.2235594466972741  ,
0.22124610306580944 ,
0.2190254151279084  ,
0.21689156109286437 ,
0.21483864169053704 ,
0.21286134813242005 ,
0.21095490451577004 ,
0.20911497401611173 ,
0.2073375952260715  ,
0.2056191369914803  ,
0.20395626246322832 ,
0.2023458985907516  ,
0.20078520958483292 ,
0.1992715736223654  ,
0.19780256230826973 ,
0.19637592251235278 ,
0.1949895602620522  ,
0.19364152642059432 ,
0.1923300039202573  ,
0.19105329635408339 ,
0.18980981775758993 ,
0.1885980834358084  ,
0.1874167017109422  ,
0.18626436648288813 ,
0.18513985050919277 ,
0.18404199932325566 ,
0.18296972572000475 ,
0.18192200474722012 ,
0.1808978691483399  ,
0.1798964052092112  ,
0.1789167489669307  ,
0.17795808274388192 ,
0.17701963197435483 ,
0.176100662294855   ,
0.17520047687248821 ,
0.1743184139486074  ,
0.17345384457744822 ,
0.1726061705416161  ,
0.17177482242824527 ,
0.17095925785132352 ,
0.17015895980717644 ,
0.16937343515142797 ,
0.1686022131869265  ,
0.16784484435315555 ,
0.16710089900858707 ,
0.16636996629825243 ,
0.16565165309952865 ,
0.16494558303981427 ,
0.1642513955803411  ,
0.16356874516090092 ,
0.16289730040073108 ,
0.16223674335123192 ,
0.16158676879657857 ,
0.1609470835986097  ,
0.16031740608271486 ,
0.159697465461696   ,
0.1590870012948564  ,
0.15848576297977574 ,
0.15789350927445678 ,
0.15731000784770738 ,
0.15673503485580131 ,
0.15616837454360177 ,
0.15560981886849612 ,
0.1550591671456024  ,
0.15451622571282903 ,
0.153980807614483   ,
0.15345273230222173 ,
0.15293182535221747 ,
0.1524179181975119  ,
0.15191084787459072]

x3=[0.9999993712640157 ,
0.9998616253052083 ,
0.9998139042887634 ,
0.999793343630279  ,
0.9997835589213175 ,
0.9997763714991208 ,
0.9997704430429099 ,
0.9997657796029439 ,
0.9997630498118607 ,
0.9997607940843253 ,
0.9997585342780717 ,
0.9997562919812607 ,
0.9997541424917241 ,
0.9997521241506214 ,
0.9997502551653246 ,
0.9997485149897333 ,
0.9997468880325229 ,
0.9997453626274715 ,
0.999744021287352  ,
0.9997427734005592 ,
0.9997415872127332 ,
0.9997404536909915 ,
0.9997393702591997 ,
0.9997383357491185 ,
0.999737349019804  ,
0.9997364086724938 ,
0.9997355130642749 ,
0.9997346603843277 ,
0.9997337917520075 ,
0.9997330009083988 ,
0.9997321902561332 ,
0.999731464685418  ,
0.9997307153969157 ,
0.9997300520142944 ,
0.9997293626218837 ,
0.9997286652996474 ,
0.9997279845392668 ,
0.9997273286260153 ,
0.9997266984640942 ,
0.9997260933214983 ,
0.9997255122956008 ,
0.9997249544619276 ,
0.9997244188718777 ,
0.9997239045721198 ,
0.9997234106243628 ,
0.9997229361152887 ,
0.9997224801604114 ,
0.9997220419060691 ,
0.9997216205308764 ,
0.9997212152468091 ,
0.9997208252997962 ,
0.9997204499698195 ,
0.9997200885705961 ,
0.9997197404489614 ,
0.999719404984     ,
0.9997190815860247 ,
0.9997187696954416 ,
0.9997184687815449 ,
0.9997181783412654 ,
0.999717897897889  ,
0.9997176269998055 ,
0.999717365219234  ,
0.9997171121510114 ,
0.9997168674113694 ,
0.9997166306367868 ,
0.9997164014828683 ,
0.9997161796232603 ,
0.9997159647486077 ,
0.9997157565655803 ,
0.999715554795892  ,
0.9997153591754143 ,
0.99971516945328   ,
0.999714985391048  ,
0.9997148067618713 ,
0.9997146333497157 ,
0.9997144649485796 ,
0.999714301361717  ,
0.9997141424008995 ,
0.9997139878856369 ,
0.9997138376424249 ,
0.9997136915039553 ,
0.9997135493083181 ,
0.9997134108981612 ,
0.9997132761198286 ,
0.9997131448224299 ,
0.9997130168568764 ,
0.9997128920748346 ,
0.9997127703276193 ,
0.9997126514650059 ,
0.9997125353339348 ,
0.9997124217771451 ,
0.9997123106316683 ,
0.9997122017272252 ,
0.9997120948845094 ,
0.9997119899133061 ,
0.9997118866104965 ,
0.999711784757919  ,
0.9997116841200551 ,
0.9997115844415863 ,
0.9997114854447564 ,
0.9997113868265952]

for i in range(51):
    μ0[i]=x0[2*i]
    μ1[i]=x1[2*i]
    μ2[i]=x2[2*i]
    μ3[i]=x3[2*i]


plt.figure(8)
fig, ax = plt.subplots(2, 2, figsize=[14, 12])
#Change the figure size
plt.figure(figsize=[16, 12])
#plt.suptitle('Evolution of moments', fontsize=19)
plt.subplot(2,2,1)
plt.plot(r.t,r.y[0,:]/initial_m[0],'.r',r.t,μ0/initial_m[0],'-b')
pp.xlabel('t(min)',{"fontsize":16})
pp.ylabel('m0(t)/m0(0)',{"fontsize":16})
pp.legend(('Maximum Entropy','Finite Elements (Comsol)'),loc='upper right',borderaxespad=0.1, fontsize=15)
pp.title('(a)Evolution of zeroth moment',fontsize=15)
plt.subplot(2,2,2)
plt.plot(r.t,r.y[1,:]/initial_m[1],'.r',r.t,μ1/initial_m[1],'-b')
pp.xlabel('t(min)',{"fontsize":16})
pp.ylabel('m1(t)/m1(0)',{"fontsize":16})
pp.title('(b)Evolution of first moment',fontsize=15)
pp.legend(('Maximum Entropy','Finite Elements (Comsol)'),loc='upper right',borderaxespad=0.1, fontsize=15)
plt.subplot(2,2,3)
plt.plot(r.t,r.y[2,:]/initial_m[2],'.r',r.t,μ2/initial_m[2],'-b')
pp.xlabel('t(min)',{"fontsize":16})
pp.ylabel('m2(t)/m2(0)',{"fontsize":16})
pp.title('(c)Evolution of second moment',fontsize=15)
pp.legend(('Maximum Entropy','Finite Elements (Comsol)'),loc='upper right',borderaxespad=0.1, fontsize=15)
plt.subplot(2,2,4)
plt.plot(r.t,r.y[3,:]/initial_m[3],'.r',[0,100],[1,1],'-b')
pp.xlabel('t(min)',{"fontsize":16})
pp.ylabel('m3(t)/m3(0)',{"fontsize":16})
pp.title('(d)Evolution of third moment',fontsize=15)
pp.legend(('Maximum Entropy','Finite Elements (Comsol)'),loc='upper right',borderaxespad=0.1, fontsize=15)
plt.show




L=np.linspace(0,12,51)
pp.figure(6)

muc100 = [x0[-1],x1[-1],x2[-1],x3[-1]]
solc100, lambdasc100 = maxent_reconstruct_c0_1(mu=muc100,bnds=[0,12])

muc20 = [μ0[10],μ1[10],μ2[10],μ3[10]]
solc20, lambdasc20 = maxent_reconstruct_c0_1(mu=muc20,bnds=[0,8])

pp.plot(L,sol100(L),'.r', L, solc100(L),'-b')
pp.title('t = 100')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n (#/μm.mL)',{"fontsize":16})

plt.figure(8)
plt.figure(figsize=[14, 14])
plt.subplot(2,2,1)
plt.plot(L,sol20(L),'.r', L, solc20(L),'-b')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n (#/μm.mL)',{"fontsize":16})
pp.legend(('Maximum Entropy','Finite Elements (Comsol)'),loc='upper right',borderaxespad=0.1, fontsize=10)
pp.title('(a)20 min',fontsize=15)

plt.subplot(2,2,2)
plt.plot(L,sol100(L),'.r', L, solc100(L),'-b')
pp.xlabel('L (μm)',{"fontsize":16})
pp.ylabel('n (#/μm.mL)',{"fontsize":16})
pp.legend(('Maximum Entropy','Finite Elements (Comsol)'),loc='upper right',borderaxespad=0.1, fontsize=10)
pp.title('(b)100 min',fontsize=15)


